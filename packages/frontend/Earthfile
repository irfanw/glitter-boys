VERSION 0.7

node:
  FROM node:lts
  WORKDIR /workspace
  RUN npm install -g npm

build:
  FROM +node
  COPY ../data+build/dist packages/data/dist
  WORKDIR packages/frontend/
  COPY . .
  # solves https://github.com/npm/cli/issues/4828
  RUN rm package-lock.json
  RUN npm i
  RUN npm run build
  SAVE ARTIFACT dist

wrangler:
  FROM +node
  RUN npm install -g wrangler

deploy:
  ARG EARTHLY_GIT_HASH
  ARG EARTHLY_GIT_BRANCH
  ARG --required stage
  FROM +wrangler
  COPY +build/dist dist
  RUN --secret=CLOUDFLARE_ACCOUNT_ID --secret=CLOUDFLARE_API_TOKEN wrangler pages deploy dist --project-name=glitter-boys --branch=$EARTHLY_GIT_BRANCH --commit-hash=$EARTHLY_GIT_HASH
